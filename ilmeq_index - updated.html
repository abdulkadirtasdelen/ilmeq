<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ILMEQ</title>
  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; padding: 20px; }
    .file-item { margin-bottom: 5px; font-size: 0.95rem; }
    #fileList { max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #fff; }
    .graph-box { height: 600px; border: 1px solid #dee2e6; border-radius: 5px; background-color: #ffffff; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4">📁 ILMEQ (Interlinked Ledger Metadata for Educational Qualifications)</h2>

  <div class="mb-4">
    <label class="form-label">Select Folder:</label>
    <input type="file" id="folderInput" class="form-control" webkitdirectory directory multiple />
  </div>

  <div class="mb-4">
    <label class="form-label">Upload JSON-LD:</label>
    <input type="file" id="jsonldInput" class="form-control" accept="application/ld+json" />
  </div>

  <div class="mb-4">
    <h5>📄 Uploaded Files</h5>
    <div id="fileList"></div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Source File</label>
      <select class="form-select" id="selectFrom"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Relationship</label>
      <select class="form-select" id="relationType">
        <option value="is_parent_of">is_parent_of</option>
        <option value="is_child_of">is_child_of</option>
        <option value="is_equivalent_to">is_equivalent_to</option>
        <option value="requires">requires</option>
        <option value="is_required_by">is_required_by</option>
        <option value="is_based_on">is_based_on</option>
        <option value="supplements">supplements</option>
        <option value="required_for">required_for</option>
        <option value="associated_with">associated_with</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Target File</label>
      <select class="form-select" id="selectTo"></select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button onclick="addRelation()" class="btn btn-primary w-100">➕ Add</button>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-5">
      <input type="text" id="externalHash" class="form-control" placeholder="SHA256 hash">
    </div>
    <div class="col-md-5">
      <input type="text" id="externalName" class="form-control" placeholder="Document name">
    </div>
    <div class="col-md-2">
      <button onclick="addExternal()" class="btn btn-outline-secondary w-100">Add External File</button>
    </div>
  </div>

  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h5>📋 Relation List</h5>
      <button onclick="clearRelations()" class="btn btn-sm btn-outline-danger">🧹 Clear All Relations</button>
    </div>
    <ul id="relationList" class="list-group mt-2"></ul>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-12">
      <h5 class="text-primary">🔍 Graph for Issuer (File name)</h5>
      <div id="network1" class="graph-box"></div>
    </div>
    <div class="col-md-12">
      <h5 class="text-primary">🔐 Graph for Blockchain (Hash)</h5>
      <div id="network2" class="graph-box"></div>
    </div>
  </div>

  <div class="mb-3">
    <p class="text-muted">

<span class="badge bg-success text-light" style="background-color: #4ade80;">Active</span> 
<span class="badge text-light" style="background-color: #BBBBBB;">Passive</span>
<span class="badge bg-danger text-light">Revoked</span>
<span class="badge bg-warning text-dark">Expired</span>
<span class="badge text-light" style="background-color: #9098ea;">Pending</span>
<span class="badge bg-info text-dark">Suspended</span>
<span class="badge bg-light text-dark">Archived</span>

<!--
bg-primary	    #0d6efd	Mavi (ana renk)
bg-secondary	#6c757d	Gri (ikincil)
bg-success	    #198754	Yeşil (başarılı)
bg-danger	    #dc3545	Kırmızı (hata)
bg-warning	    #ffc107	Sarı (uyarı)
bg-info	        #0dcaf0	Açık mavi (bilgi)
bg-light	    #f8f9fa	Açık gri
bg-dark	        #212529	Koyu
-->
    </p>
    <button onclick="generateJson()" class="btn btn-success">📄 Create JSON-LD and Download</button>
  </div>
</div>

<script>
const folderInput = document.getElementById('folderInput');
const jsonldInput = document.getElementById('jsonldInput');
const fileListDiv = document.getElementById('fileList');
const selectFrom = document.getElementById('selectFrom');
const selectTo = document.getElementById('selectTo');
const selectedFiles = [];
const relations = [];

const statusColors = {
  active: '#4ade80',
  passive: '#bbbbbb',
  revoked: '#dc3545',
  expired: '#ffc107',
  pending: '#9098ea',
  suspended: '#0dcaf0',
  archived: '#f8f9fa'
  
};

folderInput.addEventListener('change', async (e) => {
  const files = e.target.files;
  fileListDiv.innerHTML = '';
  selectedFiles.length = 0;
  selectFrom.innerHTML = '';
  selectTo.innerHTML = '';

  for (let file of files) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    selectedFiles.push({ name: file.webkitRelativePath, hash: hashHex, status: 'active', include: true });
  }

  renderFileList();
  updateSelectors();
  drawGraph();
});

jsonldInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  try {
    const jsonld = JSON.parse(text);
    if (jsonld.documents) {
      selectedFiles.push(...jsonld.documents.map(d => ({
        name: d.name || d['@id'],
        hash: d['@id'].replace('hash:', ''),
        status: d.status || 'active',
        include: true
      })));
    }
    if (jsonld.relations) {
      relations.push(...jsonld.relations.map(r => ({
        source: r.source.replace('hash:', ''),
        target: r.target.replace('hash:', ''),
        relation: r.relation.replace('relation:', '')
      })));
    }
    renderFileList();
    updateSelectors();
    drawGraph();
    renderRelationList();
  } catch (err) {
    alert('Invalid JSON-LD file');
  }
});

function renderFileList() {
  fileListDiv.innerHTML = '';
  selectedFiles.forEach((f, i) => {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `
      <input type="checkbox" checked onchange="toggleInclude(${i})"> 
      <b>${f.name}</b> 
      [<small>${f.hash.slice(0, 10)}...</small>] 
      Status: 
      <select onchange="changeStatus(${i}, this.value)">
        ${Object.keys(statusColors).map(s => `<option value="${s}" ${f.status === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}
      </select>
    `;
    fileListDiv.appendChild(div);
  });
}

function toggleInclude(index) {
  selectedFiles[index].include = !selectedFiles[index].include;
  updateSelectors();
  drawGraph();
}

function changeStatus(index, status) {
  selectedFiles[index].status = status;
  drawGraph();
}

function updateSelectors() {
  selectFrom.innerHTML = '';
  selectTo.innerHTML = '';
  const included = selectedFiles.filter(f => f.include);
  included.forEach(f => {
    selectFrom.appendChild(new Option(f.name, f.hash));
    selectTo.appendChild(new Option(f.name, f.hash));
  });
}

function addRelation() {
  const source = selectFrom.value;
  const target = selectTo.value;
  const relation = document.getElementById('relationType').value;
  if (source === target) return alert("Same file cannot be related to itself.");
  relations.push({ source, relation, target });
  drawGraph();
  renderRelationList();
}

function addExternal() {
  const hash = document.getElementById('externalHash').value.trim();
  const name = document.getElementById('externalName').value.trim();
  if (!hash || !name) return alert("Enter a valid hash and name.");
  selectedFiles.push({ name, hash, status: 'active', include: true });
  renderFileList();
  updateSelectors();
  drawGraph();
}

function renderRelationList() {
  const relationList = document.getElementById('relationList');
  relationList.innerHTML = '';
  relations.forEach((r, i) => {
    const fromFile = selectedFiles.find(f => f.hash === r.source);
    const toFile = selectedFiles.find(f => f.hash === r.target);
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      <span>${fromFile?.name || r.source} —[<strong>${r.relation}</strong>]→ ${toFile?.name || r.target}</span>
      <button class="btn btn-sm btn-outline-danger" onclick="removeRelation(${i})">🗑️</button>
    `;
    relationList.appendChild(li);
  });
}

function removeRelation(index) {
  if (confirm("Are you sure you want to delete this relation?")) {
    relations.splice(index, 1);
    drawGraph();
    renderRelationList();
  }
}

function clearRelations() {
  if (relations.length === 0) {
    alert("No relations to clear.");
    return;
  }
  if (confirm("Are you sure you want to remove ALL relations?")) {
    relations.length = 0;
    drawGraph();
    renderRelationList();
  }
}

function drawGraph() {
  const included = selectedFiles.filter(f => f.include);
  const nodes = included.map(f => ({
    id: f.hash,
    label: f.name,
    color: statusColors[f.status] || '#ccc'
  }));
  const edges = relations.map(r => ({ from: r.source, to: r.target, label: r.relation, arrows: 'to' }));

  new vis.Network(document.getElementById('network1'), {
    nodes: new vis.DataSet(nodes),
    edges: new vis.DataSet(edges)
  }, { nodes: { shape: 'box' }, edges: { font: { align: 'top' } }, physics: false });

  const nodesHash = included.map(f => ({
    id: f.hash,
    label: f.hash.slice(0, 10) + '...',
    color: statusColors[f.status] || '#ccc'
  }));
  new vis.Network(document.getElementById('network2'), {
    nodes: new vis.DataSet(nodesHash),
    edges: new vis.DataSet(edges)
  }, { nodes: { shape: 'box' }, edges: { font: { align: 'top' } }, physics: false });

  renderRelationList();
}

function generateJson() {
  const context = {
    "@context": {
      "hash": "https://example.org/hash/",
      "relation": "https://example.org/relation/",
      "status": "https://example.org/status/"
    },
    "documents": selectedFiles.filter(f => f.include).map(f => ({
      "@id": "hash:" + f.hash,
      "name": f.name,
      "status": f.status
    })),
    "relations": relations.map(r => ({
      "relation": "relation:" + r.relation,
      "source": "hash:" + r.source,
      "target": "hash:" + r.target
    }))
  };
  const blob = new Blob([JSON.stringify(context, null, 2)], { type: 'application/ld+json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'metadata.jsonld';
  a.click();
}
</script>
</body>
</html>
